<!DOCTYPE html>
<html lang="en">

    <!-- Mirrored from dl.dropboxusercontent.com/u/5308045/mahjong/index.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 17 Jul 2014 10:12:23 GMT -->
    <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
    <head>
        <meta charset="UTF-8" />
        <!--[if lt IE 9]><script type="text/javascript" src="bin/flashcanvas.js"></script><![endif]-->
        <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
        <title>Mahjong solitaire</title>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/phaser/2.0.6/phaser.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <style>
            *{
                margin : 0;
            }
        </style>
    </head>
    <body>

    </body>
    <script type="text/javascript">
        var width = $(window).width();
        var height = $(window).height();
        var nbTile = 36;
        var tileWidth = 64;
        var tileHeight = 88;
        var playableTile = 18;
        var nbTileRow = 6;

        var tilesGroup;
        var aPosit = new Array();
        var aPositSuffle = new Array();
        var lastTile = null;
        $(function() {
            var game = new Phaser.Game(width, height, Phaser.CANVAS, 'phaser-example', {preload: preload, create: create, update: update, render: render});
            function preload() {
                game.load.spritesheet('tiles', 'assets/images/symbols.png', tileWidth, tileHeight, 72);
                shufflingTiles();
            }

            function create() {

                tilesGroup = game.add.group();
                left = 0;
                j = 0;
                for (var i = 0; i < playableTile; i++) {
                    var frame = parseInt(Math.random() * nbTile);
                    var tile = tilesGroup.create(aPositSuffle[j].x, aPositSuffle[j].y, 'tiles');
                    tile.frame = frame;
                    tile.id = j;
                    tile.posit = aPositSuffle[j].i;
                    j++;

                    var tile = tilesGroup.create(aPositSuffle[j].x, aPositSuffle[j].y, 'tiles');
                    tile.frame = frame;
                    tile.id = j;
                    tile.posit = aPositSuffle[j].i;
                    j++;
                }

                tilesGroup.setAll('inputEnabled', true);
                tilesGroup.callAll('events.onInputDown.add', 'events.onInputDown', matching);
            }

            function update() {

            }

            function render() {

            }


            function matching(tile) {

                console.log(tile);

                if (canSelect(tile)) {

                    tile.frame += nbTile;
                    if (lastTile != null) {

                        if ((lastTile.frame == tile.frame) && (lastTile.id != tile.id)) {
                            lastTile.destroy();
                            tile.destroy();
                            aPosit[tile.posit].destroy = 1;
                            aPosit[lastTile.posit].destroy = 1;
                        }
                        lastTile.frame -= nbTile;
                        tile.frame -= nbTile;
                        lastTile = null;
                    } else {
                        lastTile = tile;
                    }
                }
            }

            function canSelect(tile) {

                posit = tile.id;
                index = tile.posit;

                leftTile = parseInt(index - 1);
                rightTile = parseInt(index + 1);

                haveTileLeft = false;
                haveTileRight = false;

                if (aPosit[posit].haveTileLeft) {
                    haveTileLeft = aPosit[posit].haveTileLeft;
                }

                if (aPosit[posit].haveTileRight) {
                    haveTileRight = aPosit[posit].haveTileRight;
                }


                var bRet = true;
                if (!haveTileLeft || !haveTileRight) {
                    bRet = true;
                    console.log('base')
                } else {
                    console.log('destroy')
                    if ((aPosit[leftTile].destroy === 1) || (aPosit[rightTile].destroy === 1)) {
                        bRet = true;
                    } else {
                        bRet = false;
                    }
                }

                return bRet;
            }

            function shufflingTiles() {

                var middle_left = width / 2;
                var middle_top = height / 2;
                var nbTileToMiddle = parseInt(nbTileRow / 2);
                var x = middle_left - (nbTileToMiddle * tileWidth);
                var y = middle_top - (nbTileToMiddle * tileHeight);
                var nbElemRow = 0;
                var haveTileLeft;
                var haveTileRight;
                for (var i = 0; i < playableTile * 2; i++) {


                    haveTileLeft = ((i % 6) === 0) ? false : true;
                    haveTileRight = (((i + 1) % 6) == 0) ? false : true;
                    aPosit[i] = {i: i, x: parseInt(parseFloat(x + (nbElemRow * tileWidth))), y: parseInt(y), destroy: 0, haveTileLeft: haveTileLeft, haveTileRight: haveTileRight};

                    nbElemRow++;
                    if (nbElemRow >= nbTileRow) {
                        nbElemRow = 0;
                        y += parseFloat(tileHeight);
                    }

                }
                aPositSuffle = aPosit;
                aPositSuffle = Phaser.Utils.shuffle(aPositSuffle);

            }
        });


    </script>
</html>